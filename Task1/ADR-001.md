# ADR-001: MVP системы мониторинга скота

**Статус:** ⚠️ На рассмотрении  
**Участники:** Кондрашов Михаил  
**Дата:** 16.08.2025

---

## 1. Контекст

Требуется запустить MVP платформу мониторинга скота. При этом на текущем этапе ее планируется применять внутри компании, однако в будущем планируется продавать ее как SaaS решение.

Из списка требований исключены пункты, которые в большей степени связаны с выбором оборудования и нейросетевой моделью, так как это выходит за рамки дизайна системы.

## 2. Требования

### Функциональные

| Категория       | Требование                  |
|-----------------|-----------------------------|
| **F1**  | фиксировать признаки беспокойного поведения или драк среди животных и оповещать оператора |
| **F2**  | фиксировать признаки задавливания поросят |
| **F3**  | управлять кормушками и поилками разных производителей |
| **F4**  | следить за состоянием систем фильтрации воды |
| **F5**  | пересчитывать поголовье |
| **F6**  | следить за запасами еды и прогнозировать расход |
| **F7**  | делать пересчёт животных |
| **F8**  | поддерживать необходимое количество видеокамер для аналитики в реальном времени от разных производителей |
| **F9**  | быть построена по принципу «центральный сервер — агенты» на конкретных фермах без ограничения количества таких агентов (в синхронизации между агентами и центральным сервером допускается задержка до 10 минут без учёта проблем со связью) |
| **F10**  | предоставлять базовые метрики для передачи в другие системы |
| **F11**  | поддерживать возможность добавления собственных метрик |
| **F12**  | работать даже в случае отсутствия интернета и при необходимости отправлять уведомления дежурному сотруднику на местах мониторинга, а после восстановления связи синхронизироваться с центральной системой |
| **F13**  | иметь разделение ролей и поддерживать современные способы аутентификации и авторизации |
| **F14**  | иметь API для создания мобильного приложения или веб-приложения |

### Нефункциональные

| Категория       | Требование                  |
|-----------------|-----------------------------|
| **R1**  | обеспечивать достаточно высокую отказоустойчивость 99,95% |
| **P1**  | иметь высокую производительность — от момента возникновения нештатной ситуации, зафиксированной с помощью видеоаналитики, должно проходить не более 5 секунд до момента оповещения |
| **P2**  | позволять системе видеоаналитики реагировать в реальном времени (миллисекунды) |
| **S1**  | быть расширяемой, то есть иметь возможность разработать новый функционал без изменений существующего |
| **+**   | На ферме нестабильный WiFi, поэтому нужно продумать альтернативные каналы связи |
| **+**   | На каждой ферме допустимо использовать один центральный сервер и необходимый набор edge-устройств |

---

## 3. Решение

### Общая часть

В обеих альтернативах будет предполагаться, что имеется центральный хаб, который агрегирует аналитику со всех подключаемых ферм, что удовлетворяет `F9`. На этапе MVP планируется максимально использовать текущую инфраструктуру платформы АгроТех Х, а потому для хранения данных следует использовать существующий DWH, аналитический модуль и веб-портал с соответствующими доработками под новые данные. Получение метрик от агентов должно происходить с использованием Kafka (`F10`), кроме того это позволит сохранить характер взаимодействия подписка/публикация, что также позволит удовлетворить вторую часть `F9` (с условием, что конкретные сервисы-агенты следят за согласованностью данных).

Предполагается, что авторизовать и аутентифицировать пользователей будет именно центральная система, однако это можно изменить на более поздних этапах.

Для соблюдения R1 и S1 для для локального сервиса следует выбрать микросервисную архитектуру.

### Альтернатива 1: Централизованная модель

Централизованный сервис мониторинга, который собирает данные со всех датчиков (F4, F6), управляет контроллерами кормушек и поилок (F3), стриминг и хранение записей с камер (F8), включает в себя нейросетевой модуль, отвечающий за распознавание животных, их состояния и т.п. (F1, F2, F5, F7).

На этапе MVP из-за нестабильности WiFi передача видеопотока будет проходить через мобильную сеть, но в связи с важностью скорости и стабильности доставки, следует рассмотреть физические кабели. Для соблюдения `F12` наиболее гарантированным способом отправки уведомлений станет SMS.

```plantuml
@startuml Agrotech Centralized System Context
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

Person(operator, "Оператор", "Сотрудник на ферме")
Person(analytic, "Аналитик", "Работа с BI-системой")

System_Ext(cameras, "Fish-eye камеры")
System_Ext(sensors, "Датчики в хлевах", "Климат, качество воды и т.п.")
System_Ext(controllers, "Контролеры кормушек и поилок")


System(localService, "Система мониторинга", "Система для управления и мониторинга фермой")

System(centralHub, "Центральный хаб", "Аналитика, данные, веб-интерфейс")

Rel_D(cameras, localService, "Передача данных", "4G")
Rel_D(sensors, localService, "Передача данных", "LoRaWan")
Rel_U(localService, controllers, "Управление кормушками и поилками", "Modbus TCP")

Rel_D(localService, centralHub, "Передача метрик", "Kafka Protocol")
Rel_U(centralHub, localService, "Аутентификация и авторизация", "HTTP")

Rel_R(operator, localService, "Мониторинг скота")
Rel_L(localService, operator, "Уведомления о происшествиях", "SMS")
Rel_U(analytic, centralHub, "Анализирует данные")

LAYOUT_WITH_LEGEND()
@enduml
```

#### Последствия

**✅ Положительные:**

- Более простой вариант с точки зрения инфраструктуры и разработки
- Проще поддерживать
- Более дешевый вариант

**⚠️ Негативные:**

- Меньшая надежность каналов связи между устройствами и локальной системой
- Более высокие задержки передачи и обработки данных данных

**↗️ Зависимости:**

- Стабильная мобильная сеть

### Альтернатива 2: Распределенная модель

Конкретные агенты должны иметь свою инфраструктуру и обеспечивать критичную функциональность независимо от работоспособности центрального сервера ферма. При этом, благодаря тому, что каждый агент имеет собственную инфраструктуру на случай сбоя, для обмена данными с сервером можно использовать WiFi несмотря на его нестабильность.

Центральный сервер в данном случае будет лишь предоставлять API и агрегировать получаемые с агентов данные.

```plantuml
@startuml Agrotech Distributed System Context
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml

Person(operator, "Оператор", "Сотрудник на ферме")
Person(analytic, "Аналитик", "Работа с BI-системой")

System(cattleMonitoring, "Мониторинг скота", "Камеры + нейросетевая модель + уведомления")
System(conditionsControlService, "Контроль условий в хлеву", "Климат, качество воды, управление кормушками и поилками")

System(localService, "Система мониторинга", "Локальный сервис мониторинга")

System(centralHub, "Центральный хаб", "Аналитика, данные, веб-интерфейс")

Rel_D(cattleMonitoring, localService, "Передача данных (в т.ч. видео)", "AMQP (RTSP для видео)")
Rel_D(conditionsControlService, localService, "Передача данных", "AMQP")
Rel_U(localService, conditionsControlService, "Управление кормушками", "HTTP")

Rel_D(localService, centralHub, "Передача метрик")
Rel_U(centralHub, localService, "Синхронизация данных о сотрудниках", "AMQP")

Rel_R(operator, localService, "Мониторинг скота")
Rel_L(cattleMonitoring, operator, "Уведомления о происшествиях", "SMS")
Rel_U(analytic, centralHub, "Анализирует данные")

LAYOUT_WITH_LEGEND()
@enduml
```

#### Последствия

**✅ Положительные:**

- Более независимые компоненты, которые могут обеспечивать критическую функциональность при условии изоляции
- Меньшая зависимость от внешних условий (стабильность WiFi, качество мобильной связи)
- Более оперативная "реакция" конкретных агентов на определенные события

**⚠️ Негативные:**

- Сложность разработки
- Сложность инфраструктуры и ее относительная дороговизна
- Сложнее поддерживать

**↗️ Зависимости:**

- Подходящая инфраструктура "на местах"
