# ADR-002: Проработка систем и их инфраструктуры

**Статус:** ⚠️ На рассмотрении  
**Участники:** Кондрашов Михаил  
**Дата:** 16.08.2025

---

## 1. Контекст

Требуется запустить MVP платформу мониторинга скота. При этом на текущем этапе ее планируется применять внутри компании, однако в будущем планируется продавать ее как SaaS решение.

Из списка требований исключены пункты, которые в большей степени связаны с выбором оборудования и нейросетевой моделью, так как это выходит за рамки дизайна системы.

Здесь более подробно будет рассмотрен дизайн систем.

## 2. Требования

### Функциональные

| Категория       | Требование                  |
|-----------------|-----------------------------|
| **F1**  | фиксировать признаки беспокойного поведения или драк среди животных и оповещать оператора |
| **F2**  | фиксировать признаки задавливания поросят |
| **F3**  | управлять кормушками и поилками разных производителей |
| **F4**  | следить за состоянием систем фильтрации воды |
| **F5**  | пересчитывать поголовье |
| **F6**  | следить за запасами еды и прогнозировать расход |
| **F7**  | делать пересчёт животных |
| **F8**  | поддерживать необходимое количество видеокамер для аналитики в реальном времени от разных производителей |
| **F9**  | быть построена по принципу «центральный сервер — агенты» на конкретных фермах без ограничения количества таких агентов (в синхронизации между агентами и центральным сервером допускается задержка до 10 минут без учёта проблем со связью) |
| **F10**  | предоставлять базовые метрики для передачи в другие системы |
| **F11**  | поддерживать возможность добавления собственных метрик |
| **F12**  | работать даже в случае отсутствия интернета и при необходимости отправлять уведомления дежурному сотруднику на местах мониторинга, а после восстановления связи синхронизироваться с центральной системой |
| **F13**  | иметь разделение ролей и поддерживать современные способы аутентификации и авторизации |
| **F14**  | иметь API для создания мобильного приложения или веб-приложения |

### Нефункциональные

| Категория       | Требование                  |
|-----------------|-----------------------------|
| **R1**  | обеспечивать достаточно высокую отказоустойчивость 99,95% |
| **P1**  | иметь высокую производительность — от момента возникновения нештатной ситуации, зафиксированной с помощью видеоаналитики, должно проходить не более 5 секунд до момента оповещения |
| **P2**  | позволять системе видеоаналитики реагировать в реальном времени (миллисекунды) |
| **S1**  | быть расширяемой, то есть иметь возможность разработать новый функционал без изменений существующего |
| **+**   | На ферме нестабильный WiFi, поэтому нужно продумать альтернативные каналы связи |
| **+**   | На каждой ферме допустимо использовать один центральный сервер и необходимый набор edge-устройств |

---

## 3. Решение

### Центральный хаб

На начальном этапе следует максимально переиспользовать аналитический и ERP блоки, инфраструктуру, а также веб-портал, доработав их под новые данные.

В центральную систему следует также добавить сервис идентификации, поддерживающий OIDC, для выполнения `F13`, например Keycloak. Сервисы-агенты должны будут выполнять аутентификацию и авторизацию пользователей через него на этапе MVP, но в будущем следует предусмотреть локальные сервисы идентификации, которые синхронизируются с центральным, если окажется, что нестабильный интернет будет мешать работе пользователей.

```plantuml
@startuml C2 Container Context
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(analytic, "Аналитик", "Работа с BI-системой")

System(localService, "Система мониторинга скота")

System_Boundary(centralHub, "АгроПром Х - Цифровая платформа") {
    Container(веб_портал, "Веб-портал", "React", "Управление хозяйством")
    ContainerDb(erp, "ERP система (1С:Агро)", "1С", "Финансы, склад, кадры")
    
    Container(kafka, "Брокер сообщений", "Apache Kafka", "Шина данных")

    Container_Boundary(данные, "Хранилища данных") {
        ContainerDb(data_lake, "Data Lake", "MinIO", "Сырые данные (S3-совместимое)")
        ContainerDb(dwh, "Data Warehouse", "ClickHouse", "Структурированные данные")
    }
    
    Container(identity, "Сервис идентификации", "Keycloak", "Аутентифицирует и авторизует пользователей")

    Container(bi, "BI система", "Power BI", "Отчеты и визуализация")
    Container(аналитика, "Аналитический модуль", "Python+Spark", "Анализ эффективности")
}
Rel(analytic, bi, "Анализирует")

Rel(localService, kafka, "Передача метрик", "Kafka Protocol")
Rel(identity, localService, "Аутентификация и авторизация", "HTTP")

Rel(kafka, data_lake, "Сырые данные", "Kafka Connect+S3")
Rel(kafka, dwh, "Трансформированные данные", "ETL+Airflow")

Rel(data_lake, аналитика, "Доступ к сырым данным", "Spark")
Rel(dwh, аналитика, "Доступ к структурированным данным", "SQL")
Rel(аналитика, bi, "Передает отчеты", "ODBC")
Rel(аналитика, веб_портал, "Формирует рекомендации", "WebSocket")

Rel(веб_портал, erp, "Синхронизация данных", "REST API")
Rel(erp, dwh, "Бизнес-данные", "ETL")

LAYOUT_WITH_LEGEND()
@enduml 
```

### Альтернатива 1: Централизованная модель

Для получения, обработки и сохранения данных с датчиков можно переиспользовать IoT шлюз и Базу временных рядов текущей системы с соответствующими доработками под новые данные и инфраструктуру. NodeRED позволит добавлять новые устройства и обработку метрик с помощью low code интерфейса, что поможет удовлетворить F11.

Для соблюдения P1 и P2, видео с камер должно передаваться нейросетевому модулю локального сервера, который будет отвечать за отправку уведомлений с помощью СМС шлюза. Затем, видео будет ретранслировано в IoT шлюз, который будет сохранять видео и ретранслировать его еще раз в API для возможности просмотра пользователем. При этом на текущем этапе достаточно сохранять записи видео в локальное хранилище (жесткий диск), однако в будущем следует проработать возможность и необходимость в центральном хабе.

В системе также есть API, с возможностью разработать мобильное приложение или веб-приложение F14, которое будет отображать пользователю текущее состояние животных, климатические данные в хлевах и прочие необходимые метрики. Кроме того следует позволить пользователем смотреть видео-трансляции с камер, а также просматривать записи. Потенциально можно добавить возможность управления поилками и кормушками через API

Аутентификацию и авторизацию в API будет производиться через центральный хаб в соответствии с описанием выше.

```plantuml
@startuml C2 Container Context
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(operator, "Оператор", "Сотрудник на ферме")

System_Ext(cameras, "Fish-eye камеры")
System_Ext(sensors, "Датчики в хлевах", "Климат, качество воды и т.п.")
System_Ext(controllers, "Контролеры кормушек и поилок") 

System(centralHub, "АгроПром Х - Цифровая платформа")

System_Boundary(localService, "Система мониторинга скота") {
    Container(iot_шлюз, "IoT шлюз", "Node-RED (reused)", "Сбор данных")
    Container(tsdb, "База временных рядов", "TimescaleDB (reused)", "Данные датчиков")
    
    Container(mlAnalytics, "Сервис видеоаналитики", "ML model", "Распознавание и сбор данных")
    Container(smsGateway, "СМС-шлюз", ,"Локальный сервис/устройство для отправки СМС")

    Container(api, "API метрик", "ASP.NET Core", "Данные об условиях в хлеве, данные о животных, рестриминг камер и работа с записями")
    Container(webApp, "Web App", "React", "Веб-фронтэнд для работы с данными")
}

Rel_R(operator, webApp, "Использует")

Rel(webApp, api, "Отправляет запросы", "HTTP")
Rel(api, tsdb, "Получает данные", "SQL")

Rel(centralHub, api, "Авторизует", "HTTP")

Rel(iot_шлюз, api, "Передача видеопотока", "RTSP")
Rel(iot_шлюз, tsdb, "Сохранение данных", "SQL")
Rel(mlAnalytics, iot_шлюз, "Ретрансляция видеопотока и данных", "RTSP/HTTP")

Rel_U(mlAnalytics, smsGateway, "Отправка уведомлений")

Rel(cameras, mlAnalytics, "Трансляция видеопотока", "4G")
Rel(sensors, iot_шлюз, "Сбор данных", "LoRaWAN")
Rel(iot_шлюз, controllers, "Управление кормушками и поилками", "Modbus TCP")

Rel_L(smsGateway, operator, "Уведомления о происшествиях", "SMS")

Rel(iot_шлюз, centralHub, "Передача метрик", "Kafka Protocol")

LAYOUT_WITH_LEGEND()
@enduml 
```

### Альтернатива 2: Распределенная модель

Здесь требуется независимость агентов.

Система мониторинга скота должна включать в себя нейросетевую модели, ответственную за распознавание событий. Кроме того частью этой системы должен стать и СМС-шлюз, через который будут отправляться уведомления.

Помимо этого следует рассмотреть возможность хранить данные локально в зависимости степени необходимости избегать их потерю. Сами камеры могут быть подключены к агенту с помощью физических кабелей в силу возможности развернуть сам агент "близко" к ним.

В зависимости от требовательности нейросетевой модели к оборудованию можно рассмотреть возможность перенести часть самой тяжелой и/или несрочной видеоаналитика в центральную систему мониторинга.

Аналогичной независимостью должна обладать и система контроля условий в хлевах. Данные климатических датчиков, датчиков в кормушках, поилках и тп должны агрегироваться через NodeRED (он весьма нетребователен к оборудованию) и потенциально сохраняться в локальном хранилище (или даже в легковесной бд по типу SQLite). Кроме того NodeRED позволит управлять поилками и кормушками.

Отдельные агенты должны передавать свои данные через брокер сообщений, в данном случае RabbitMQ (кроме видео). Центральная система фермы же будет собирать все эти данные и передавать в центральный хаб и визуализировать их для пользователей.

```plantuml
@startuml C2 Container Context
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

Person(operator, "Оператор", "Сотрудник на ферме")

System_Boundary(barnControl, "Контроль условий в хлеве") {
    Container(sensors, "Датчики в хлевах", "Климат, качество воды, прочие условия")
    Container(controllers, "Контролеры кормушек и поилок")
    Container(barnGateway, "Шлюз данных", "Node-RED", "Сбор и передача данных")
}

System_Boundary(cattleMonitoring, "Контроль скота") {
    Container(cameras, "Fish-eye камеры")
    Container(mlAnalytics, "Сервис видеоаналитики", "ML model", "Распознавание и аналитика по видео")
    Container(smsGateway, "СМС-шлюз", ,"Локальный сервис/устройство для отправки СМС")
}

System_Boundary(localService, "Система мониторинга") {
    Container(tsdb, "База временных рядов", "TimescaleDB (reused)", "Данные датчиков")
    Container(iot_шлюз, "IoT шлюз", "Node-RED (reused)", "Сбор данных")

    Container(api, "API метрик", "ASP.NET Core", "Данные об условиях в хлеве, данные о животных, рестриминг камер и работа с записями")
    Container(webApp, "Web App", "React", "Веб-фронтэнд для работы с данными")
    ContainerQueue(messageBus, "Брокер сообщений", "RabbitMQ")
}

System(centralHub, "АгроПром Х - Цифровая платформа")

Rel(sensors, barnGateway, "Сбор данных", "LoRaWAN")
Rel(barnGateway, controllers, "Управление кормушками и поилками", "Modbus TCP")
Rel(barnGateway, messageBus, "Передача данных", "AMQP")

Rel(cameras, mlAnalytics, "Трансляция видеопотока", "RTSP")
Rel(mlAnalytics, messageBus, "Передача данных", "AMQP")
Rel(mlAnalytics, api, "Передача видеопотока", "RTSP")
Rel(mlAnalytics, smsGateway, "Отправка уведомлений")
Rel(smsGateway, operator, "Уведомления о происшествиях", "SMS")

Rel(operator, webApp, "Использует")
Rel(webApp, api, "Отправляет запросы", "HTTP")
Rel(centralHub, api, "Авторизует", "HTTP")
Rel(api, tsdb, "Получает данные", "SQL")

Rel(messageBus, iot_шлюз, "Передача данных", "AMQP")
Rel(iot_шлюз, tsdb, "Сохранение данных", "SQL")
Rel(iot_шлюз, centralHub, "Передача метрик", "Kafka Protocol")

LAYOUT_WITH_LEGEND()
@enduml 
```
